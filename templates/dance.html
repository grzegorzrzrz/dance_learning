<!DOCTYPE html>
<html>
<head>
    <title>Webcam Stream</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='background.css') }}">
    <style>
    #menu-button {
        z-index: 3;
    }
    </style>
</head>
<body>
    <div class="video_container">
        <div class="webcam_container">
            <img id="webcam_stream" height="300">
        </div>

        <div class="dance_video_container">
            <video id="dance_video"  height="710">
                <source src="{{ url_for('static', filename='') }}" type="video/mp4">
            </video>
        </div>
        <div class="close-range-indicator" id="indicator"></div>
        <button id="menu-button">Menu</button>
    </div>


    <div class="finishing-screen" id="finishing-screen" style="display: none;
    flex-direction: column; justify-content: center;">
        <h1>Dance Results</h1>
        <h2 id="congratulatory-message"></h1><br>
        <h2>Your dance performance: <span id="percent">0</span>%</h1><br>
        <h3>Number of Good Moves: <span id="good-moves">0</span></h2>
        <h3>Number of Excellent Moves: <span id="excellent-moves">0</span></h2>
        <h3>Number of Bad Moves: <span id="bad-moves">0</span></h2>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const imgElement = document.getElementById('webcam_stream');
        const x_button = document.getElementById('x-button');
        const streamUrl = '/webcam_stream';
        imgElement.src = streamUrl;
        const eventSource = new EventSource('/point_stream');
        const clickedItem = localStorage.getItem('clickedItem');

if (clickedItem) {
    // Set the video source based on the clicked item
    console.log(clickedItem);
    const videoElement = document.getElementById('dance_video');
    videoElement.src = `{{ url_for('static', filename='') }}${clickedItem}.mp4`;
    videoElement.load(); // Reload the video element
}

        let goodMoves = 0;
        let excellentMoves = 0;
        let badMoves = 0;

        eventSource.onmessage = function(event) {
        // Update the message on the HTML page
        console.log(event.data);
        updateIndicator(event.data);
    };

        eventSource.onerror = function(event) {
        // Handle errors
        console.error("Error with SSE:", event);
        eventSource.close();
    };



        const videoElement = document.getElementById('dance_video');
        setTimeout(() => {
    videoElement.play();
}, 1000);
        videoElement.addEventListener('play', function() {

        // When the video starts playing, send a request to the Flask server
        fetch('/video_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: '!VIDEO_START' }),
        });
    });

        function updateIndicator(moveQuality) {
            if (moveQuality === 'good') {
                goodMoves++;
                indicator.style.backgroundColor = 'green';
            } else if (moveQuality === 'excellent') {
                excellentMoves++;
                indicator.style.backgroundColor = '#02f74c';
            } else if (moveQuality === 'bad') {
                indicator.style.backgroundColor = 'red';
                badMoves++;
            } else {
                indicator.style.backgroundColor = 'transparent'; // Default
            }

            // Trigger the fade-out effect
            indicator.style.opacity = 1;
            setTimeout(() => {
                indicator.style.opacity = 0;
            }, 1000); // Adjust the delay (in milliseconds) as needed
        }

        videoElement.addEventListener('ended', () => {
            fetch('/video_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: '!VIDEO_END' }),
        });
        setTimeout( () =>{
            // Hide the video and show the finishing screen
            videoElement.style.display = 'none';
            const finishingScreen = document.getElementById('finishing-screen');
            finishingScreen.style.display = 'flex';
            imgElement.style.display = "none";


            // Display move statistics
            document.getElementById('good-moves').textContent = goodMoves;
            document.getElementById('excellent-moves').textContent = excellentMoves;
            document.getElementById('bad-moves').textContent = badMoves;

            // Assume you have a variable 'performancePercent' representing the user's dance performance percentage.
const performancePercent = 75;
            // Update the performance percentage text.
            const percentText = document.getElementById('percent');
percentText.textContent = performancePercent;

// Update the congratulatory message based on the performance.
const congratulatoryMessage = document.getElementById('congratulatory-message');
if (performancePercent >= 80) {
    congratulatoryMessage.textContent = "Congratulations! You nailed it!";
} else if (performancePercent >= 60) {
    congratulatoryMessage.textContent = "Good job! Keep practicing to reach excellence!";
} else {
    congratulatoryMessage.textContent = "Keep practicing! You'll get better with time.";
}
        }, 1000);
        });

        document.getElementById('menu-button').addEventListener('click', function() {
            window.location.href = 'menu';
        });

    </script>
</body>
</html>
